@model FacturacionWeb.ViewModels.FacturaViewModel
@{ ViewBag.Title = "Registrar Nueva Factura"; }

<h2>@ViewBag.Title</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <h4>Encabezado de la Factura</h4>
    <hr />
    <div class="form-row">
        <div class="form-group col-md-6">
            @Html.LabelFor(model => model.Factura.NumeroFactura, "Número de Factura")
            @Html.EditorFor(model => model.Factura.NumeroFactura, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.Factura.NumeroFactura, "", new { @class = "text-danger" })
        </div>
        <div class="form-group col-md-6">
            @Html.LabelFor(model => model.Factura.IdCliente, "Cliente")
            @Html.DropDownListFor(model => model.Factura.IdCliente, Model.Clientes, "Seleccione un cliente", new { @class = "form-control" })
            @Html.ValidationMessageFor(model => model.Factura.IdCliente, "", new { @class = "text-danger" })
        </div>
    </div>

    <h4 class="mt-4">Detalle de la Factura</h4>
    <hr />
    
    <div class="form-row align-items-end">
        <div class="form-group col-md-6">
            <label>Producto</label>
            @Html.DropDownList("producto-temporal", Model.Productos, "Seleccione un producto", new { @class = "form-control", id = "producto-seleccionado" })
        </div>
        <div class="form-group col-md-4">
            <label>Cantidad</label>
            <input type="number" id="cantidad-producto" class="form-control" min="1" value="1" />
        </div>
        <div class="form-group col-md-2">
            <button type="button" id="btn-agregar-producto" class="btn btn-info btn-block">Agregar</button>
        </div>
    </div>

    <table id="tabla-detalles" class="table table-bordered mt-3">
        <thead class="thead-light">
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas se agregarán aquí dinámicamente -->
        </tbody>
    </table>

    <div class="form-group mt-4">
        <input type="submit" value="Guardar Factura" class="btn btn-success" />
        @Html.ActionLink("Cancelar", "Index", null, new { @class = "btn btn-secondary" })
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            $("#btn-agregar-producto").click(function () {
                var productoId = $("#producto-seleccionado").val();
                var productoNombre = $("#producto-seleccionado option:selected").text();
                var cantidad = $("#cantidad-producto").val();

                if (productoId === "" || cantidad <= 0) {
                    alert("Por favor, seleccione un producto y una cantidad válida.");
                    return;
                }

                var fila = '<tr>' +
                    '<td>' + productoNombre + '</td>' +
                    '<td>' + cantidad + '</td>' +
                    '<td><button type="button" class="btn btn-danger btn-sm btn-eliminar">Eliminar</button></td>' +
                    '<input type="hidden" name="productoId" value="' + productoId + '" />' +
                    '<input type="hidden" name="cantidad" value="' + cantidad + '" />' +
                    '</tr>';

                $("#tabla-detalles tbody").append(fila);

                // Limpiar campos
                $("#producto-seleccionado").val('');
                $("#cantidad-producto").val('1');
            });

            // Eliminar fila
            $("#tabla-detalles").on("click", ".btn-eliminar", function () {
                $(this).closest("tr").remove();
            });
        });
    </script>
}